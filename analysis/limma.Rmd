---
title: "Initial analysis with limma"
date: 2016-05-27
output:
  html_document:
    toc: true
    toc_float: true
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options}
library("knitr")
opts_chunk$set(cache = FALSE)
```

Initial limma analysis.

## Setup

```{r packages, message=FALSE}
library("limma")
library("edgeR")
library("data.table")
library("dplyr")
library("tidyr")
library("ggplot2")
library("cowplot")
theme_set(theme_bw(base_size = 12))
```

```{r input-counts}
data_raw <- fread("../data/subread-counts-per-sample.txt")
setDF(data_raw)
```

Prepare data files.

```{r prepare-data}
anno <- data_raw %>% select(individual, status, treatment)
head(anno)
counts_raw <- data_raw %>% select(starts_with("ENSG")) %>% t %>% as.data.frame
cpm_raw <- cpm(counts_raw, log = TRUE)
```

## Remove lowly expressed genes

```{r median-density}
cpm_raw_median <- apply(cpm_raw, 1, median)
cpm_raw_median_density <- density(cpm_raw_median)
cpm_raw_density <- apply(cpm_raw, 2, density)
plot(cpm_raw_density[[1]], lty = "dotted", col = gray(0.05, alpha = 0.5),
     main = "Gene expression distribution",
     xlab = "log2 cpm", sub = "red = median; blue = cutoff")
suppress_output <- lapply(cpm_raw_density, lines, lty = "dotted",
                          col = gray(0.05, alpha = 0.5))
lines(cpm_raw_median_density, col = "red", lwd = 3)
cutoff <- 0
abline(v = cutoff, col = "blue")
```

Keeping the `r sum(cpm_raw_median > cutoff)` genes with a median log~2~ cpm greater than `r cutoff`.

```{r filter-genes}
counts <- counts_raw %>% filter(cpm_raw_median > cutoff)
```

## Model with limma

```{r design-matrix}
anno$status <- factor(anno$status, levels = c("contact", "tb"))
anno$treatment <- factor(anno$treatment, levels = c("none", "infected"))
design <- model.matrix(~treatment + status + status:treatment + individual,
                       data = anno)
colnames(design)[1] <- "Intercept"
colnames(design) <- gsub("individual", "", colnames(design))
colnames(design) <- gsub("treatment", "", colnames(design))
colnames(design) <- gsub("status", "", colnames(design))
colnames(design) <- gsub(":", ".", colnames(design))
colnames(design)
```

```{r fit-model}
y <- DGEList(counts)
y <- calcNormFactors(y)
v <- voom(y, design)
fit <- lmFit(v, design)
fit <- eBayes(fit)
topTable(fit, coef = "infected")
plotMA(fit, coef = "infected")
topTable(fit, coef = "tb")
plotMA(fit, coef = "tb")
topTable(fit, coef = "infected.tb")
plotMA(fit, coef = "infected.tb")
```

## Session information

```{r info}
sessionInfo()
```

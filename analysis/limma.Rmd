---
title: "Initial analysis with limma"
date: 2016-05-27
output:
  html_document:
    toc: true
    toc_float: true
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options}
library("knitr")
opts_chunk$set(cache = FALSE)
```

Initial limma analysis.

## Setup

```{r packages, message=FALSE}
library("limma")
library("edgeR")
library("data.table")
library("dplyr")
library("tidyr")
library("ashr")
library("ggplot2")
library("cowplot")
theme_set(theme_bw(base_size = 14))
theme_update(panel.grid.minor.x = element_blank(),
             panel.grid.minor.y = element_blank(),
             panel.grid.major.x = element_blank(),
             panel.grid.major.y = element_blank())
library("VennDiagram")
library("caret")
```

Input data.

```{r input-counts}
counts <- read.delim("../data/counts.txt", check.names = FALSE, row.names = 1)
anno <- read.delim("../data/experiment-info.txt", stringsAsFactors = FALSE)
rownames(anno) <- anno$id
anno <- anno %>% select(-id, -tube_ind)
stopifnot(colnames(counts) == rownames(anno))
```

## Model with limma

```{r design-matrix}
anno$status <- factor(anno$status, levels = c("contact", "tb"))
anno$treatment <- factor(anno$treatment, levels = c("none", "infected"))
design <- model.matrix(~treatment + status + status:treatment,
                       data = anno)
colnames(design)[1] <- "Intercept"
colnames(design) <- gsub("treatment", "", colnames(design))
colnames(design) <- gsub("status", "", colnames(design))
colnames(design) <- gsub(":", ".", colnames(design))
colnames(design)
```

```{r fit-model, fig.width=8}
y <- DGEList(counts)
y <- calcNormFactors(y)
v <- voom(y, design)
# Model individual as a random effect
corfit <- duplicateCorrelation(v, design, block = anno$individual)
corfit$consensus
v <- voom(y, design, block = anno$individual, correlation = corfit$consensus)
fit <- lmFit(v, design, block = anno$individual, correlation = corfit$consensus)
fit <- eBayes(fit)
```

```{r model-results}
op <- par(mfrow = c(1, 2))
top_treatment <- topTable(fit, coef = "infected")
top_treatment
results_treatment <- topTable(fit, coef = "infected",
                              number = nrow(counts), sort = "none")
plotMA(fit, coef = "infected", main = "Main effect of infection")
hist(results_treatment$P.Value, xlab = "p-value", main = "p-value histogram")
top_status <- topTable(fit, coef = "tb")
top_status
results_status <- topTable(fit, coef = "tb",
                           number = nrow(counts), sort = "none")
plotMA(fit, coef = "tb", main = "Main effect of status")
hist(results_status$P.Value, xlab = "p-value", main = "p-value histogram")
top_interaction <- topTable(fit, coef = "infected.tb")
top_interaction
results_interaction <- topTable(fit, coef = "infected.tb",
                                number = nrow(counts), sort = "none")
plotMA(fit, coef = "infected.tb", main = "Interaction effect")
hist(results_interaction$P.Value, xlab = "p-value", main = "p-value histogram")
par(op)
```

## Explore top hits

Boxplot function.

```{r boxplot-function}
plot_gene <- function(v, g) {
  # v - An EList object containing log2 counts per million
  # g - character vector of a single gene
  stopifnot(class(v) == "EList",
            is.character(g), length(g) == 1)
  library("tidyr")
  single_gene <- v$E[g, ]
  single_gene_long <- gather_(as.data.frame(single_gene),
                              gather_cols = colnames(single_gene))
  # For some reason, the argument value_col wouldn't work
  colnames(single_gene_long) <- "log2cpm"
  single_gene_long$sample <- rownames(single_gene_long)
  single_gene_long <- separate_(single_gene_long, col = "sample", sep = "-",
                                into = c("individual", "status", "treatment"))
  single_gene_long$status <- factor(single_gene_long$status, levels = c("contact", "tb"))
  single_gene_long$treatment <- factor(single_gene_long$treatment, levels = c("none", "infected"))
  ggplot(single_gene_long, aes(x = treatment, y = log2cpm, fill = status)) +
    geom_boxplot() +
    labs(title = g, x = "Treatment", y = expression("Expression level (" * log[2] * " cpm)"))
}
```

Infected.

```{r}
plot_grid(plot_gene(v, rownames(top_treatment)[1]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          plot_gene(v, rownames(top_treatment)[2]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          plot_gene(v, rownames(top_treatment)[3]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          nrow = 1)
```

Susceptibility status.

```{r}
plot_grid(plot_gene(v, rownames(top_status)[1]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          plot_gene(v, rownames(top_status)[2]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          plot_gene(v, rownames(top_status)[3]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          nrow = 1)
```

Interaction.

```{r}
plot_grid(plot_gene(v, rownames(top_interaction)[1]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          plot_gene(v, rownames(top_interaction)[2]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          plot_gene(v, rownames(top_interaction)[3]) +
            ylim(3, 11) + theme(legend.position = "bottom"),
          nrow = 1)
```

## Use ash for mutliple testing correction

Treatment effect.

```{r ash-treatment}
ash_treatment <- ash(betahat = fit$coefficients[, "infected"],
                     sebetahat = fit$stdev.unscaled[, "infected"])
class(ash_treatment)
names(ash_treatment)
sum(ash_treatment$svalue < .01)
hist(ash_treatment$svalue)
```

Susceptibility effect.

```{r ash-status}
ash_status <- ash(betahat = fit$coefficients[, "tb"],
                     sebetahat = fit$stdev.unscaled[, "tb"])
sum(ash_status$svalue < .01)
hist(ash_status$svalue)
```

Interaction effect.

```{r ash-interaction}
ash_interaction <- ash(betahat = fit$coefficients[, "infected.tb"],
                     sebetahat = fit$stdev.unscaled[, "infected.tb"])
sum(ash_interaction$svalue < .01)
hist(ash_interaction$svalue)
```

Venn diagram

```{r venn}
ash_treatment_de <- ash_treatment$svalue < .01
ash_status_de <- ash_status$svalue < .01
ash_interaction_de <- ash_interaction$svalue < .01
grid.newpage()
venn_rv <- draw.triple.venn(
  area1 = sum(ash_treatment_de),
  area2 = sum(ash_status_de),
  area3 = sum(ash_interaction_de),
  n12 = sum(ash_treatment_de & ash_status_de),
  n23 = sum(ash_status_de & ash_interaction_de),
  n13 = sum(ash_treatment_de & ash_interaction_de),
  n123 = sum(ash_treatment_de & ash_status_de & ash_interaction_de),
  category = c("Treatment", "Status", "Interaction"),
#   fill = c("darkolivegreen3", "cadetblue3", "darkorchid"),
  alpha = c(0.5, 0.5, 0.5), col = "black", cex = 2, cat.cex = 1.5,
  euler.d = FALSE, scaled = FALSE, ind = TRUE)
grid.draw(venn_rv)
```


## Build model to predict susceptibility status

Select those genes that are DE by status or interaction.

```{r}
genes_for_classifer <- v$E[ash_status$svalue < .01 |
                           ash_interaction$svalue < .01, ]
# genes_for_classifer <- v$E
# genes_for_classifer <- genes_for_classifer[order(ash_status$svalue)[1:3000], ]
genes_for_classifer <- t(genes_for_classifer)
dim(genes_for_classifer)
genes_for_classifer[1:5, 1:5]
```

Add susceptibility status.

```{r}
genes_for_classifer <- as.data.frame(genes_for_classifer)
genes_for_classifer$status <- anno$status
```

Fit SVM.

http://stackoverflow.com/questions/20461476/svm-with-cross-validation-in-r-using-caret

http://topepo.github.io/caret/training.html

```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 10,
                     savePred = "final", classProbs = TRUE)
set.seed(12345)
mod_svm <- train(status ~ ., data = genes_for_classifer,
             method = "svmLinear", trControl = ctrl)
mod_svm
head(mod_svm$pred)
```

How well did it work?

```{r}
# methods(class = class(mod_svm))
# names(mod_svm)
confusionMatrix(mod_svm)
mod_svm$results
```

Use an elastic net implemented in glmnet package.

```{r}
set.seed(12345)
mod_glmnet <- train(status ~ ., data = genes_for_classifer,
                    method = "glmnet", trControl = ctrl)
mod_glmnet
head(mod_glmnet$pred)
confusionMatrix(mod_glmnet)
mod_glmnet$results
```

Will test on data from Luis's PNAS paper:

```{r}
load("../data/Exp_final_Batch_corrected.Rdata")
```

## Session information

```{r info}
sessionInfo()
```

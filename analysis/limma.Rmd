---
title: "Initial analysis with limma"
date: 2016-05-27
output:
  html_document:
    toc: true
    toc_float: true
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options}
library("knitr")
opts_chunk$set(cache = FALSE)
```

Initial limma analysis.

## Setup

```{r packages, message=FALSE}
library("limma")
library("edgeR")
library("data.table")
library("dplyr")
library("tidyr")
library("ggplot2")
library("cowplot")
theme_set(theme_bw(base_size = 12))
```

Input data.

```{r input-counts}
counts <- read.delim("../data/counts.txt", check.names = FALSE, row.names = 1)
anno <- read.delim("../data/experiment-info.txt", stringsAsFactors = FALSE)
rownames(anno) <- anno$id
anno <- anno %>% select(-id, -tube_ind)
stopifnot(colnames(counts) == rownames(anno))
```

## Model with limma

```{r design-matrix}
anno$status <- factor(anno$status, levels = c("contact", "tb"))
anno$treatment <- factor(anno$treatment, levels = c("none", "infected"))
design <- model.matrix(~treatment + status + status:treatment + individual,
                       data = anno)
colnames(design)[1] <- "Intercept"
colnames(design) <- gsub("individual", "", colnames(design))
colnames(design) <- gsub("treatment", "", colnames(design))
colnames(design) <- gsub("status", "", colnames(design))
colnames(design) <- gsub(":", ".", colnames(design))
colnames(design)
```

```{r fit-model}
y <- DGEList(counts)
y <- calcNormFactors(y)
v <- voom(y, design)
fit <- lmFit(v, design)
fit <- eBayes(fit)
topTable(fit, coef = "infected")
plotMA(fit, coef = "infected")
topTable(fit, coef = "tb")
plotMA(fit, coef = "tb")
topTable(fit, coef = "infected.tb")
plotMA(fit, coef = "infected.tb")
```

## Explore top hits

Boxplot function.

```{r boxplot-function}
plot_gene <- function(v, g) {
  # v - An EList object containing log2 counts per million
  # g - character vector of a single gene
  stopifnot(class(v) == "EList",
            is.character(g), length(g) == 1)
  library("tidyr")
  single_gene <- v$E[g, ]
  single_gene_long <- gather_(as.data.frame(single_gene),
                              gather_cols = colnames(single_gene))
  # For some reason, the argument value_col wouldn't work
  colnames(single_gene_long) <- "log2cpm"
  single_gene_long$sample <- rownames(single_gene_long)
  single_gene_long <- separate_(single_gene_long, col = "sample", sep = "-",
                                into = c("individual", "status", "treatment"))
  single_gene_long$status <- factor(single_gene_long$status, levels = c("contact", "tb"))
  single_gene_long$treatment <- factor(single_gene_long$treatment, levels = c("none", "infected"))
  ggplot(single_gene_long, aes(x = treatment, y = log2cpm, fill = status)) +
    geom_boxplot() +
    labs(title = g, x = "Treatment", y = expression("Expression level (" * log[2] * " cpm)"))
}

```

Infected.

```{r}
for (g in c("ENSG00000172183", "ENSG00000100906", "ENSG00000271503")) {
  print(plot_gene(v, g))
}
```

Susceptibility status.

```{r}
for (g in c("ENSG00000254709", "ENSG00000132465", "ENSG00000107742")) {
  print(plot_gene(v, g))
}
```

Interaction.

```{r}
for (g in c("ENSG00000106605", "ENSG00000225830", "ENSG00000107099")) {
  print(plot_gene(v, g))
}
```

## Session information

```{r info}
sessionInfo()
```
